(window.webpackJsonp=window.webpackJsonp||[]).push([[276],{788:function(t,a,e){"use strict";e.r(a);var r=e(49),s=Object(r.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"websocket协议通用鉴权url生成说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#websocket协议通用鉴权url生成说明"}},[t._v("#")]),t._v(" WebSocket协议通用鉴权URL生成说明")]),t._v(" "),a("h3",{attrs:{id:"_1-鉴权说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-鉴权说明"}},[t._v("#")]),t._v(" 1. 鉴权说明")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("开发者需要自行先在控制台创建应用，利用应用中提供的appid，APIKey， APISecret进行鉴权，生成最终请求的鉴权url。鉴权方法见下方1.2。技术咨询可直接提交"),a("a",{attrs:{href:"https://console.xfyun.cn/workorder/commit",target:"_blank",rel:"noopener noreferrer"}},[t._v("工单"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"_1-2-鉴权参数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-鉴权参数"}},[t._v("#")]),t._v(" 1.2 鉴权参数")]),t._v(" "),a("hr"),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("参数")]),t._v(" "),a("th",[t._v("类型")]),t._v(" "),a("th",[t._v("必须")]),t._v(" "),a("th",[t._v("说明")]),t._v(" "),a("th",[t._v("示例")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("host")]),t._v(" "),a("td",[t._v("string")]),t._v(" "),a("td",[t._v("是")]),t._v(" "),a("td",[t._v("请求的主机")]),t._v(" "),a("td",[t._v("aichat.xf-yun.com(使用时需替换为实际使用的接口地址）")])]),t._v(" "),a("tr",[a("td",[t._v("date")]),t._v(" "),a("td",[t._v("string")]),t._v(" "),a("td",[t._v("是")]),t._v(" "),a("td",[t._v("当前时间戳，采用RFC1123格式，时间偏差需控制在300s内")]),t._v(" "),a("td",[t._v("Fri, 05 May 2023 10:43:39 GMT")])]),t._v(" "),a("tr",[a("td",[t._v("GET")]),t._v(" "),a("td",[t._v("string")]),t._v(" "),a("td",[t._v("是")]),t._v(" "),a("td",[t._v("请求方式")]),t._v(" "),a("td",[t._v("/v1.1/chat HTTP/1.1")])]),t._v(" "),a("tr",[a("td",[t._v("authorization")]),t._v(" "),a("td",[t._v("string")]),t._v(" "),a("td",[t._v("是")]),t._v(" "),a("td",[t._v("base64编码的签名信息")]),t._v(" "),a("td",[t._v("参考下方生成方式")])])])]),t._v(" "),a("p",[t._v("最终url需要的参数如上，下方以Python为例进行鉴权参数的生成示例，开发者如果使用其它开发语言可以按照相同时间戳和apikey等常量来逐步生成参数和下方示例比对，确保鉴权步骤无误")]),t._v(" "),a("h4",{attrs:{id:"_1-2-1-date参数生成规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-1-date参数生成规则"}},[t._v("#")]),t._v(" 1.2.1 date参数生成规则")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("from datetime import datetime\nfrom time import mktime\nfrom wsgiref.handlers import format_date_time\n\ncur_time = datetime.now()\ndate = format_date_time(mktime(cur_time.timetuple()))\n# 假使生成的date和下方使用的date = Fri, 05 May 2023 10:43:39 GMT\n\n")])])]),a("h4",{attrs:{id:"_1-2-2-authorization参数生成规则"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-2-authorization参数生成规则"}},[t._v("#")]),t._v(" 1.2.2 authorization参数生成规则")]),t._v(" "),a("p",[t._v("1）到控制台获取APIKey 和APISecret参数")]),t._v(" "),a("p",[t._v("2）利用上方的date动态拼接生成字符串tmp，这里以星火url为例，实际使用需要根据具体的请求url替换host和path。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('tmp = "host: " + "spark-api.xf-yun.com" + "\\n"\ntmp += "date: " + date + "\\n"\ntmp += "GET " + "/v1.1/chat" + " HTTP/1.1"\n"""上方拼接生成的tmp字符串如下\nhost: spark-api.xf-yun.com\ndate: Fri, 05 May 2023 10:43:39 GMT\nGET /v1.1/chat HTTP/1.1\n"""\n\n')])])]),a("p",[t._v("3）利用hmac-sha256算法结合APISecret对上一步的tmp签名，获得签名后的摘要tmp_sha。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("import hmac\nimport hashlib\n# 此处假设APISecret = MjlmNzkzNmZkMDQ2OTc0ZDdmNGE2ZTZi \ntmp_sha = hmac.new(self.APISecret.encode('utf-8'), tmp.encode('utf-8'), \t\t\t\t\t\tdigestmod=hashlib.sha256).digest()\n\"\"\"此时生成的tmp_sha结果如下\nb'\\xcf\\x98\\x07v\\xed\\xe9\\xc5Ux\\x0032\\x93\\x8e\\xbb\\xc0\\xe5\\x83C\\xda\\xba\\x05\\x0c\\xd1\\xdew\\xccN7?\\r\\xa4'\n\"\"\"\n\n")])])]),a("p",[t._v("4）将上方的tmp_sha进行base64编码生成signature")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('import base64\nsignature = base64.b64encode(tmp_sha).decode(encoding=\'utf-8\')\n"""此时生成的结果如下\nz5gHdu3pxVV4ADMyk467wOWDQ9q6BQzR3nfMTjc/DaQ==\n"""\n\n')])])]),a("p",[t._v("5）利用上面生成的signature，拼接下方的字符串生成authorization_origin")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('# 假设步骤1控制台获取的APIKey=addd2272b6d8b7c8abdd79531420ca3b\nauthorization_origin = f"api_key=\\"{api_key}\\", algorithm=\\"hmac-sha256\\", headers=\\"host date request-line\\", signature=\\"{signature}\\""\n"""此时生成的authorization_origin字符串如下\napi_key="addd2272b6d8b7c8abdd79531420ca3b", algorithm="hmac-sha256", headers="host date request-line", signature="z5gHdu3pxVV4ADMyk467wOWDQ9q6BQzR3nfMTjc/DaQ="\n"""\n\n')])])]),a("p",[t._v("6）最后再将上方的authorization_origin进行base64编码,生成最终的authorization")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('authorization = base64.b64encode(authorization_origin.encode(\'utf-8\')).decode(encoding=\'utf-8\')\n"""此时生成的authorization如下\nYXBpX2tleT0iYWRkZDIyNzJiNmQ4YjdjOGFiZGQ3OTUzMTQyMGNhM2IiLCBhbGdvcml0aG09ImhtYWMtc2hhMjU2IiwgaGVhZGVycz0iaG9zdCBkYXRlIHJlcXVlc3QtbGluZSIsIHNpZ25hdHVyZT0iejVnSGR1M3B4VlY0QURNeWs0Njd3T1dEUTlxNkJRelIzbmZNVGpjL0RhUT0i\n"""\n\n')])])]),a("h4",{attrs:{id:"_1-2-3-生成最终url"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-3-生成最终url"}},[t._v("#")]),t._v(" 1.2.3 生成最终url")]),t._v(" "),a("p",[t._v("将鉴权参数组合成最终的键值对，并urlencode生成最终的握手url。开发者可先根据上面的步骤一步步进行参数校验，确保生成的参数无误。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v('from urllib.parse import urlencode\n\nv = {\n\t\t"authorization": authorization, # 上方鉴权生成的authorization\n        "date": date,  # 步骤1生成的date\n    \t"host": "spark-api.xf-yun.com" # 请求的主机名，根据具体接口替换\n}\nurl = "wss://spark-api.xf-yun.com/v1.1/chat?" + urlencode(v)\n"""生成的最终url如下\nwss://spark-api.xf-yun.com/v1.1/chat?authorization=YXBpX2tleT0iYWRkZDIyNzJiNmQ4YjdjOGFiZGQ3OTUzMTQyMGNhM2IiLCBhbGdvcml0aG09ImhtYWMtc2hhMjU2IiwgaGVhZGVycz0iaG9zdCBkYXRlIHJlcXVlc3QtbGluZSIsIHNpZ25hdHVyZT0iejVnSGR1M3B4VlY0QURNeWs0Njd3T1dEUTlxNkJRelIzbmZNVGpjL0RhUT0i&date=Fri%2C+05+May+2023+10%3A43%3A39+GMT&host=spark-api.xf-yun.com\n"""\n\n')])])])])}),[],!1,null,null,null);a.default=s.exports}}]);