# AI推荐缓存配置说明

## 概述

AI推荐系统已实现智能缓存机制，根据用户行为数据量自动调整缓存时间，提高响应速度并减少AI调用成本。

## 缓存策略

### 缓存时间配置

- **短缓存 (5分钟)**: 行为数据 < 5条
- **标准缓存 (15分钟)**: 行为数据 5-14条  
- **长缓存 (30分钟)**: 行为数据 ≥ 15条

### 冷却期配置

- **冷却期**: 防止频繁调用AI，在固定时间内不生成新缓存
- **默认冷却期**: 5分钟，可通过环境变量配置

### 环境变量配置

```bash
# AI缓存配置
AI_CACHE_TTL=900          # 默认缓存时间(秒)
AI_SHORT_CACHE_TTL=300    # 短缓存时间(秒)
AI_LONG_CACHE_TTL=1800    # 长缓存时间(秒)
AI_COOLDOWN_TTL=300       # 冷却期时间(秒)，默认5分钟
```

## 缓存机制

### 缓存键生成

缓存键格式: `ai_recommend:{user_id}:{limit}`

- `user_id`: 用户ID
- `limit`: 推荐商品数量

**注意**: 缓存键已简化，不包含行为内容，确保在固定时间内使用同一个缓存。

### 缓存存储

1. **Redis缓存** (优先): 如果Redis可用，使用Redis存储
2. **内存缓存** (备用): Redis不可用时，使用内存存储

## 管理接口

### 获取缓存信息

```http
POST /api/v1/ai_strategy/service-control
Content-Type: application/json

{
    "action": "get_cache_info"
}
```

### 清理缓存

```http
POST /api/v1/ai_strategy/service-control
Content-Type: application/json

{
    "action": "clear_cache",
    "user_id": 123  // 可选，清理特定用户缓存
}
```

### 获取服务统计

```http
GET /api/v1/ai_strategy/service-stats
```

## 缓存优势

1. **智能时间管理**: 根据数据丰富程度调整缓存时间
2. **用户隔离**: 每个用户独立缓存，互不影响
3. **自动清理**: 过期缓存自动清理，避免内存泄漏
4. **降级机制**: Redis不可用时自动使用内存缓存
5. **管理便捷**: 提供完整的缓存管理接口

## 使用场景

- **首页推荐**: 用户首次访问后，后续访问直接返回缓存结果
- **重复请求**: 相同行为序列的重复请求直接返回缓存
- **性能优化**: 减少AI API调用，提高响应速度
- **成本控制**: 降低AI服务使用成本

## 注意事项

1. 缓存基于用户行为序列，行为变化会生成新的缓存键
2. 推荐数量变化会生成不同的缓存键
3. 管理员可通过接口查看和清理缓存
4. 内存缓存有大小限制(1000个键)，超出会自动清理过期项
