# 校园二手交易平台技术方案说明书

## 1. 项目概述

### 1.1 项目背景
校园二手交易平台是一个基于现代化Web技术栈构建的综合性二手商品交易系统，专门为校园用户设计。平台集成了科大讯飞星火大模型AI智能推荐功能，提供智能化的商品识别、价格分析和推荐服务。

### 1.2 项目目标
- 为校园用户提供安全、便捷的二手商品交易平台
- 通过AI技术提升用户体验和交易效率
- 构建完整的用户社交和交易生态系统
- 实现响应式设计，支持多端访问

### 1.3 核心特色
- 🤖 **AI智能推荐** - 基于科大讯飞星火大模型的智能商品识别和价格分析
- 💬 **实时聊天系统** - 支持用户间实时沟通和交易协商
- 📱 **响应式设计** - 完美适配PC端和移动端
- 🔍 **智能搜索** - 支持多维度商品搜索和筛选
- 👥 **社交功能** - 好友系统、关注机制、评论互动

## 2. 技术架构

### 2.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端 (Vue.js)  │    │   后端 (FastAPI) │    │   数据库 (MySQL) │
│                 │    │                 │    │                 │
│ - Vue 3         │◄──►│ - FastAPI       │◄──►│ - MySQL 8.0     │
│ - Vue Router    │    │ - SQLAlchemy    │    │ - 关系型数据库   │
│ - Pinia         │    │ - Pydantic      │    │ - 事务支持       │
│ - Axios         │    │ - JWT认证       │    │ - 索引优化       │
│ - 响应式设计    │    │ - WebSocket     │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │   AI服务集成    │
                       │                 │
                       │ - 科大讯飞星火   │
                       │ - 图片识别      │
                       │ - 价格分析      │
                       │ - 智能推荐      │
                       └─────────────────┘
```

### 2.2 技术栈详情

#### 后端技术栈
- **Web框架**: FastAPI 0.104.1
- **ORM**: SQLAlchemy 2.0
- **数据库**: MySQL 8.0
- **认证**: JWT (python-jose)
- **密码加密**: passlib
- **WebSocket**: websocket-client, websockets
- **HTTP客户端**: requests
- **环境管理**: python-dotenv

#### 前端技术栈
- **框架**: Vue.js 3.5.13
- **路由**: Vue Router 4.5.1
- **状态管理**: Pinia 3.0.3
- **HTTP客户端**: Axios 1.10.0
- **构建工具**: Vite 6.3.5
- **UI组件**: 原生CSS + FontAwesome图标

#### AI服务集成
- **AI模型**: 科大讯飞星火大模型
- **API版本**: v1.0
- **功能**: 图片识别、商品信息补全、价格分析
- **通信协议**: WebSocket

### 2.3 系统架构特点
- **微服务架构**: 前后端分离，API驱动
- **RESTful API**: 标准化的API设计
- **实时通信**: WebSocket支持实时消息
- **AI集成**: 无缝集成第三方AI服务
- **安全认证**: JWT token认证机制
- **数据持久化**: 关系型数据库存储

## 3. 数据库设计

### 3.1 核心数据模型

#### 用户系统 (User)
```sql
CREATE TABLE users (
    id INT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(200) UNIQUE NOT NULL,
    phone VARCHAR(20) UNIQUE,
    hashed_password VARCHAR(200) NOT NULL,
    avatar VARCHAR(200) DEFAULT 'default_avatar.png',
    location VARCHAR(100),
    bio TEXT,
    contact VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_active BOOLEAN DEFAULT TRUE,
    is_admin BOOLEAN DEFAULT FALSE,
    last_login TIMESTAMP NULL,
    followers INT DEFAULT 0,
    following INT DEFAULT 0,
    items_count INT DEFAULT 0
);
```

#### 商品系统 (Item)
```sql
CREATE TABLE items (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    price FLOAT NOT NULL,
    category VARCHAR(50),
    condition VARCHAR(20) DEFAULT 'unknown',
    status VARCHAR(20) DEFAULT 'online' NOT NULL,
    location VARCHAR(100),
    images VARCHAR(500),
    owner_id INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    sold BOOLEAN DEFAULT FALSE,
    views INT DEFAULT 0,
    favorited_count INT DEFAULT 0,
    like_count INT DEFAULT 0,
    FOREIGN KEY (owner_id) REFERENCES users(id)
);
```

#### 消息系统 (Message)
```sql
CREATE TABLE messages (
    id INT PRIMARY KEY AUTO_INCREMENT,
    content TEXT NOT NULL,
    user_id INT NOT NULL,
    item_id INT,
    buy_request_id INT,
    target_user VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_read BOOLEAN DEFAULT FALSE,
    is_system BOOLEAN DEFAULT FALSE,
    title VARCHAR(200),
    target_users VARCHAR(500),
    deleted_by_sender BOOLEAN DEFAULT FALSE,
    deleted_by_receiver BOOLEAN DEFAULT FALSE,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (item_id) REFERENCES items(id),
    FOREIGN KEY (buy_request_id) REFERENCES buy_requests(id)
);
```

### 3.2 扩展功能表

#### 求购系统 (BuyRequest)
```sql
CREATE TABLE buy_requests (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    title VARCHAR(100) NOT NULL,
    description TEXT,
    budget DECIMAL(10,2),
    images VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

#### 社交系统
- **好友关系** (friends)
- **黑名单** (blacklist)
- **收藏** (favorites)
- **评论** (comments)
- **点赞** (item_likes, comment_likes, buy_request_likes)

### 3.3 数据库优化策略
- **索引优化**: 为常用查询字段建立索引
- **分页查询**: 支持大数据量的分页加载
- **软删除**: 支持数据软删除机制
- **事务管理**: 确保数据一致性
- **连接池**: 优化数据库连接性能

## 4. API设计

### 4.1 API架构
```
/api/v1/
├── auth/           # 认证相关
├── users/          # 用户管理
├── items/          # 商品管理
├── messages/       # 消息系统
├── buy_requests/   # 求购系统
├── comments/       # 评论系统
├── favorites/      # 收藏系统
├── friends/        # 好友系统
├── feedback/       # 反馈系统
├── admin/          # 管理后台
└── ai_strategy/    # AI策略
```

### 4.2 核心API接口

#### 认证接口
- `POST /api/v1/auth/login` - 用户登录
- `POST /api/v1/auth/register` - 用户注册
- `POST /api/v1/auth/refresh` - 刷新Token
- `POST /api/v1/auth/forgot-password` - 忘记密码

#### 商品接口
- `GET /api/v1/items` - 获取商品列表
- `POST /api/v1/items` - 发布商品
- `GET /api/v1/items/{id}` - 获取商品详情
- `PUT /api/v1/items/{id}` - 更新商品
- `DELETE /api/v1/items/{id}` - 删除商品
- `POST /api/v1/items/ai-auto-complete` - AI自动补全

#### 消息接口
- `GET /api/v1/messages` - 获取消息列表
- `POST /api/v1/messages` - 发送消息
- `PUT /api/v1/messages/{id}/read` - 标记已读
- `DELETE /api/v1/messages/{id}` - 删除消息

### 4.3 API安全机制
- **JWT认证**: 基于Token的身份验证
- **权限控制**: 基于角色的访问控制
- **输入验证**: Pydantic模型验证
- **CORS配置**: 跨域资源共享控制
- **速率限制**: API调用频率限制

## 5. AI智能推荐系统

### 5.1 AI功能概述
平台集成了科大讯飞星火大模型，提供以下AI功能：

#### 核心功能
- **商品图片识别**: 自动识别商品类型、品牌、型号
- **信息自动补全**: 基于图片自动填充商品信息
- **价格智能分析**: 分析市场价格竞争力
- **低价好物推荐**: 推荐性价比最高的商品

### 5.2 AI技术实现

#### 科大讯飞API集成
```python
class SparkAIService:
    def __init__(self):
        self.app_id = os.getenv("XUNFEI_APP_ID")
        self.api_key = os.getenv("XUNFEI_API_KEY")
        self.api_secret = os.getenv("XUNFEI_API_SECRET")
        self.spark_url = os.getenv("XUNFEI_SPARK_URL")
    
    def auto_complete_item_by_image(self, image_bytes_list: list) -> dict:
        """通过图片调用星火大模型自动补全商品信息"""
        
    def analyze_price_competition(self, current_items: List[Dict]) -> Dict:
        """分析当前网站商品的价格竞争力"""
```

#### AI功能流程
1. **图片上传**: 用户上传1-4张商品图片
2. **AI识别**: 调用星火大模型进行图片识别
3. **信息提取**: 提取商品类型、品牌、型号等信息
4. **价格分析**: 分析市场价格和竞争力
5. **结果返回**: 返回结构化的商品信息

### 5.3 AI配置参数
```python
# 星火大模型配置
XUNFEI_APP_ID: str = os.getenv("XUNFEI_APP_ID", "")
XUNFEI_API_KEY: str = os.getenv("XUNFEI_API_KEY", "")
XUNFEI_API_SECRET: str = os.getenv("XUNFEI_API_SECRET", "")
XUNFEI_SPARK_URL: str = os.getenv("XUNFEI_SPARK_URL", "wss://spark-api.xf-yun.com/v1/x1")
```

### 5.4 AI功能优势
- **提升效率**: 减少用户手动输入时间
- **提高准确性**: AI识别减少人为错误
- **智能推荐**: 基于数据分析的智能推荐
- **用户体验**: 简化商品发布流程

## 6. 前端架构

### 6.1 前端技术栈
- **Vue.js 3**: 渐进式JavaScript框架
- **Vue Router 4**: 前端路由管理
- **Pinia**: 状态管理库
- **Axios**: HTTP客户端
- **Vite**: 现代化构建工具

### 6.2 组件架构
```
src/
├── components/          # 通用组件
│   ├── SearchBar.vue    # 搜索栏
│   ├── ProductCard.vue  # 商品卡片
│   ├── BottomNav.vue    # 底部导航
│   ├── CommentSection.vue # 评论区域
│   └── ImagePreview.vue # 图片预览
├── views/               # 页面组件
│   ├── Home.vue         # 首页
│   ├── LoginRegister.vue # 登录注册
│   ├── PublishItem.vue  # 发布商品
│   ├── ItemDetail.vue   # 商品详情
│   ├── Chat.vue         # 聊天页面
│   ├── Profile.vue      # 个人中心
│   └── Admin.vue        # 管理后台
├── services/            # 服务层
│   └── api.js           # API接口
├── store/               # 状态管理
│   └── auth.js          # 认证状态
└── router/              # 路由配置
    └── index.js         # 路由定义
```

### 6.3 响应式设计
- **移动优先**: 优先适配移动端体验
- **断点设计**: 支持多种屏幕尺寸
- **触摸优化**: 针对触摸操作优化
- **性能优化**: 图片懒加载、组件懒加载

### 6.4 用户体验设计
- **直观导航**: 清晰的导航结构
- **快速操作**: 一键发布、快速搜索
- **实时反馈**: 操作状态实时反馈
- **错误处理**: 友好的错误提示

## 7. 安全机制

### 7.1 认证安全
- **JWT Token**: 基于Token的无状态认证
- **密码加密**: bcrypt算法加密存储
- **Token过期**: 自动Token刷新机制
- **会话管理**: 安全的会话控制

### 7.2 数据安全
- **输入验证**: 严格的输入数据验证
- **SQL注入防护**: ORM防止SQL注入
- **XSS防护**: 输出数据转义
- **CSRF防护**: 跨站请求伪造防护

### 7.3 文件安全
- **文件类型验证**: 限制上传文件类型
- **文件大小限制**: 防止大文件攻击
- **路径安全**: 安全的文件存储路径
- **访问控制**: 文件访问权限控制

## 8. 性能优化

### 8.1 后端优化
- **数据库连接池**: 优化数据库连接
- **查询优化**: 索引优化和查询缓存
- **异步处理**: 非阻塞异步操作
- **API缓存**: Redis缓存热点数据

### 8.2 前端优化
- **代码分割**: 按需加载组件
- **图片优化**: 图片压缩和懒加载
- **缓存策略**: 浏览器缓存优化
- **CDN加速**: 静态资源CDN分发

### 8.3 网络优化
- **HTTP/2**: 支持HTTP/2协议
- **Gzip压缩**: 响应数据压缩
- **资源合并**: CSS/JS文件合并
- **缓存控制**: 合理的缓存策略

## 9. 部署方案

### 9.1 开发环境
```bash
# 后端启动
python main.py

# 前端启动
cd frontend
npm run dev
```

### 9.2 生产环境部署

#### Docker部署
```dockerfile
# 后端Dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### 服务器配置
- **操作系统**: Ubuntu 20.04 LTS
- **Web服务器**: Nginx
- **应用服务器**: Gunicorn + Uvicorn
- **数据库**: MySQL 8.0
- **缓存**: Redis (可选)

### 9.3 环境变量配置
```bash
# 数据库配置
MYSQL_USER=root
MYSQL_PASSWORD=your_password
MYSQL_SERVER=localhost
MYSQL_PORT=3306
MYSQL_DB=ershou

# 安全配置
SECRET_KEY=your-secret-key
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=10080

# AI服务配置
XUNFEI_APP_ID=your-app-id
XUNFEI_API_KEY=your-api-key
XUNFEI_API_SECRET=your-api-secret
```

## 10. 监控与维护

### 10.1 日志管理
- **应用日志**: 记录应用运行状态
- **错误日志**: 记录异常和错误信息
- **访问日志**: 记录API访问情况
- **性能日志**: 记录性能指标

### 10.2 监控指标
- **系统性能**: CPU、内存、磁盘使用率
- **应用性能**: 响应时间、吞吐量
- **数据库性能**: 查询时间、连接数
- **用户行为**: 访问量、转化率

### 10.3 备份策略
- **数据库备份**: 定期全量备份
- **文件备份**: 用户上传文件备份
- **配置备份**: 系统配置文件备份
- **灾难恢复**: 完整的恢复方案

## 11. 扩展性设计

### 11.1 水平扩展
- **负载均衡**: Nginx负载均衡
- **数据库分片**: 支持数据库水平分片
- **缓存集群**: Redis集群部署
- **微服务拆分**: 支持服务拆分

### 11.2 功能扩展
- **支付集成**: 支持多种支付方式
- **物流集成**: 物流信息跟踪
- **第三方登录**: 微信、QQ等登录
- **消息推送**: 实时消息推送

### 11.3 技术升级
- **框架升级**: 支持技术栈升级
- **数据库迁移**: 支持数据库迁移
- **API版本**: 支持API版本管理
- **向后兼容**: 保持向后兼容性

## 12. 项目特色与创新

### 12.1 AI智能推荐
- **图片识别**: 基于AI的商品图片识别
- **智能定价**: AI辅助价格分析
- **个性化推荐**: 基于用户行为的推荐
- **市场洞察**: AI分析市场趋势

### 12.2 社交化交易
- **好友系统**: 用户好友关系管理
- **关注机制**: 用户关注和粉丝系统
- **评论互动**: 商品评论和回复
- **私信聊天**: 用户间私信沟通

### 12.3 用户体验优化
- **响应式设计**: 完美适配多端
- **实时通信**: WebSocket实时消息
- **智能搜索**: 多维度搜索功能
- **一键发布**: 简化商品发布流程

## 13. 风险评估与应对

### 13.1 技术风险
- **AI服务依赖**: 第三方AI服务稳定性
- **数据安全**: 用户数据泄露风险
- **性能瓶颈**: 高并发访问压力
- **技术债务**: 代码维护成本

### 13.2 应对策略
- **服务降级**: AI服务不可用时的降级方案
- **数据加密**: 敏感数据加密存储
- **性能优化**: 持续的性能监控和优化
- **代码重构**: 定期的代码重构和维护

## 14. 项目总结

### 14.1 技术亮点
1. **现代化技术栈**: 采用最新的Web技术栈
2. **AI智能集成**: 深度集成AI功能
3. **响应式设计**: 完美适配多端设备
4. **实时通信**: 支持实时消息交互
5. **安全可靠**: 完善的安全机制

### 14.2 商业价值
1. **用户价值**: 提供便捷的二手交易平台
2. **技术价值**: 展示AI技术在电商领域的应用
3. **社会价值**: 促进校园资源循环利用
4. **创新价值**: 创新的AI+电商模式

### 14.3 发展前景
1. **功能扩展**: 支持更多交易场景
2. **技术升级**: 持续的技术优化和升级
3. **用户增长**: 扩大用户群体和市场份额
4. **生态建设**: 构建完整的交易生态系统

---

**文档版本**: v1.0  
**最后更新**: 2024年12月  
**编写人员**: 技术团队  
**审核人员**: 项目经理 